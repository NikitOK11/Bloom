// This is your Prisma schema file
// Learn more at: https://pris.ly/d/prisma-schema

// ARCHITECTURE DECISION:
// We use PostgreSQL for production-ready database support.
// The DATABASE_URL is configured via environment variables,
// allowing different configurations for local dev vs Docker vs production.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MODEL - AUTHENTICATION ONLY
// ==========================================
// DOMAIN RULE: User represents authentication identity only.
// Personal information is stored in the Profile model.
// This separation allows:
// - Clear domain boundaries (auth vs profile data)
// - Users can exist without profiles (pre-onboarding state)
// - Profile can be required for certain actions (e.g., join requests)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   @default("") // Hashed password (placeholder for MVP, default empty for migration)
  name      String   // Display name for identification
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdTeams     Team[]            @relation("TeamCreator")
  teamMembers      TeamMember[]
  joinRequests     JoinRequest[]     // User's requests to join teams
  profile          Profile?          // 1-to-1 relation to Profile (optional until created)
  externalProfiles ExternalProfile[] // Connected external platform profiles (Kaggle, GitHub, etc.)
}

// ==========================================
// PROFILE MODEL - USER'S EXTENDED INFO
// ==========================================
// DOMAIN RULE: Profile is REQUIRED to:
// - Send join requests to teams
// - Be visible to team leaders reviewing requests
// 
// PRIVACY RULE: Profiles are NOT publicly browsable.
// They can only be viewed by:
// 1. The profile owner (for editing)
// 2. Team leaders reviewing join requests from this user
//
// FLOW: User registers → User creates profile → User can join teams
model Profile {
  id                 String   @id @default(cuid())
  role               String   @default("school_student") // school_student, college_student, graduate, other
  gradeOrYear        String?  // e.g., "11th grade", "2nd year", "PhD"
  interests          String   // Comma-separated: "algorithms,ml,data_science"
  skills             String   @default("") // Comma-separated: "python,sql,math"
  olympiadExperience String?  // Free text about past olympiad participation
  about              String?  // General "about me" section
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // 1-to-1 relation to User
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Olympiad Model
// Represents an academic olympiad competition.
// Teams can be associated with a specific olympiad.
// Updated: Now supports Russian olympiads with structured data
model Olympiad {
  id          String    @id @default(cuid())
  slug        String    @unique // URL-friendly identifier: "yandex-cup", "aidao"
  name        String    // Original name (never translated)
  shortName   String    @unique // Short code for display: "Yandex Cup", "AIDAO"
  description String?   // Russian description
  year        Int       // Competition year
  level       String    @default("смешанная") // "школьная", "студенческая", "смешанная"
  subject     String    // Main discipline for backwards compatibility
  disciplines String?   // Comma-separated: "Алгоритмы,ML,Data Science"
  teamSize    String?   // Russian string: "3–5 человек"
  format      String?   // "онлайн", "оффлайн", "смешанный"
  organizer   String?   // Organizer name
  website     String?   // Official website URL
  logoEmoji   String?   // Emoji for visual identity
  startDate   DateTime? // Competition start date
  endDate     DateTime? // Competition end date
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  teams Team[]
}

// Team Model
// DOMAIN RULE: A team MUST belong to exactly one olympiad.
// Teams cannot exist independently - they are always created
// within the context of a specific olympiad competition.
// This ensures data integrity and clear team-olympiad association.
model Team {
  id             String   @id @default(cuid())
  name           String
  description    String?
  requiredSkills String   // Comma-separated skills needed
  maxMembers     Int      @default(4)
  isOpen         Boolean  @default(true) // Whether team is accepting members
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // TEAM REQUIREMENTS:
  // These fields help users understand what the team is looking for
  // and enable smart filtering on the team list page.
  requiredInterests String?  // Comma-separated: "algorithms,machine_learning,data_science"
  requiredLevel     String   @default("any") // "beginner", "intermediate", "advanced", "any"
  requirementsNote  String?  // Short free-text note from team leader about what they're looking for

  // Relations
  creatorId    String
  creator      User          @relation("TeamCreator", fields: [creatorId], references: [id])
  members      TeamMember[]
  joinRequests JoinRequest[] // Incoming join requests for this team
  
  // Required relation to Olympiad - teams must belong to an olympiad
  olympiadId  String
  olympiad    Olympiad     @relation(fields: [olympiadId], references: [id])
}

// TeamMember Model (Join Table)
// Links users to teams with additional metadata.
// Allows tracking when someone joined and their role.
model TeamMember {
  id       String   @id @default(cuid())
  role     String   @default("member") // "creator" or "member"
  joinedAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Ensure a user can only be in a team once
  @@unique([userId, teamId])
}

// JoinRequest Model
// DOMAIN RULE: Users cannot be added to teams directly.
// They must submit a join request that the team leader approves.
// This ensures proper control over team membership.
model JoinRequest {
  id        String   @id @default(cuid())
  // Status: "PENDING", "APPROVED", "REJECTED"
  status    String   @default("PENDING")
  message   String?  // Optional message from the requester
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Ensure a user can only have one active request per team
  // Note: This doesn't prevent multiple requests with different statuses,
  // but business logic enforces only one PENDING request at a time
  @@unique([userId, teamId, status])
  @@index([teamId, status]) // For efficient querying of pending requests
}

// ==========================================
// EXTERNAL PROFILE MODEL - THIRD-PARTY INTEGRATIONS
// ==========================================
// DOMAIN RULE: ExternalProfile stores read-only data from external platforms.
// This model is designed to be provider-agnostic, supporting multiple platforms
// (Kaggle, GitHub, Codeforces, etc.) via the provider field.
//
// INTEGRATION LIMITATIONS:
// - Read-only: We fetch public profile data, not submissions or activity
// - No background sync: Data is only updated when user manually refreshes
// - No API tokens stored: Tokens are used only during fetch, not persisted
// - Public data only: We only store publicly visible profile information
//
// PRIVACY: Users control their connected profiles and can disconnect anytime.
model ExternalProfile {
  id        String   @id @default(cuid())
  
  // Which platform this profile is from
  // Values: "kaggle", "github", "codeforces" (extensible)
  provider  String
  
  // External platform username
  username  String
  
  // Full URL to the external profile
  profileUrl String
  
  // Platform-specific rank/tier (e.g., "Grandmaster", "Expert", "Novice")
  rankTier  String?
  
  // Medal counts (nullable as not all platforms have these)
  medalsGold   Int?
  medalsSilver Int?
  medalsBronze Int?
  
  // Competition/contest participation count
  competitionsCount Int?
  
  // Last time we fetched data from the external platform
  lastSyncedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // User can only have one profile per provider
  @@unique([userId, provider])
  @@index([userId])
}
